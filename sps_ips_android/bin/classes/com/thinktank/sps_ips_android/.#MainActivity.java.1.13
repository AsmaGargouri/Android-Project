package com.thinktank.sps_ips_android;

import java.util.List;

import android.app.AlertDialog;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Matrix;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.support.v4.view.ViewPager;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBar.Tab;
import android.support.v7.app.ActionBarActivity;
import android.text.Html;
import android.text.Spanned;
import android.text.TextUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.view.ViewTreeObserver;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.RelativeLayout;

import com.thinktank.sps_ips_android.Model.Catch;
import com.thinktank.sps_ips_android.Model.GsmCell;
import com.thinktank.sps_ips_android.Model.Wifi;

public class MainActivity extends ActionBarActivity {

	private ViewPager pager;

	ActionBar mActionbar;

	private String selectedImagePath;

	protected static final int PICK_IMAGE = 1;

	public static int widthImage = 0;
	public static int heightImage = 0;

	public boolean isWifiEnabled = false;

	Uri selectedImageUri;
	
	public static int originalWImage = 0 ; 
	public static int originaHImage = 0 ; 

	@Override
	protected void onCreate(Bundle savedInstanceState) {

		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		mActionbar = getSupportActionBar();

		mActionbar.setNavigationMode(ActionBar.NAVIGATION_MODE_TABS);

		pager = (ViewPager) findViewById(R.id.pager);

		FragmentManager fm = getSupportFragmentManager();

		ViewPager.SimpleOnPageChangeListener pageChangeListener = new ViewPager.SimpleOnPageChangeListener() {

			@Override
			public void onPageSelected(int position) {
				super.onPageSelected(position);
				mActionbar.setSelectedNavigationItem(position);
			}
		};

		pager.setOnPageChangeListener(pageChangeListener);

		FragmentsPagerAdapter fragmentPagerAdapter = new FragmentsPagerAdapter(
				fm);

		pager.setAdapter(fragmentPagerAdapter);

		mActionbar.setDisplayShowTitleEnabled(true);

		ActionBar.TabListener tabListener = new ActionBar.TabListener() {

			@Override
			public void onTabReselected(Tab arg0, FragmentTransaction arg1) {
			}

			@Override
			public void onTabSelected(Tab tab, FragmentTransaction arg1) {
				pager.setCurrentItem(tab.getPosition());
			}

			@Override
			public void onTabUnselected(Tab arg0, FragmentTransaction arg1) {
			}

		};

		Tab start_tab = mActionbar.newTab().setText("Home")
				.setTabListener(tabListener);
		mActionbar.addTab(start_tab);

		Tab map_tab = mActionbar.newTab().setText("Collect")
				.setTabListener(collectListener);
		mActionbar.addTab(map_tab);

		Tab visualize_data_tab = mActionbar.newTab().setText("Visualize")
				.setTabListener(tabListenerData);
		mActionbar.addTab(visualize_data_tab);

		Tab analysis_tab = mActionbar.newTab().setText("Analysis")
				.setTabListener(tabListenerAnalysis);
		mActionbar.addTab(analysis_tab);

		CatchDataBaseHandler db = new CatchDataBaseHandler(
				getApplicationContext());

		db.deleteAllCatchs();
		db.deleteAllWifis();
		db.deleteAllWifis_catch();
		db.deleteAllGsmCells();
		db.deleteAllGsmCells_catch();

	}

	ActionBar.TabListener tabListenerData = new ActionBar.TabListener() {

		@Override
		public void onTabReselected(Tab arg0, FragmentTransaction arg1) {
			Log.w("tablistener DATA", "ontab reselected");
			getData();

		}

		@Override
		public void onTabSelected(Tab tab, FragmentTransaction arg1) {

			Log.w("tablistener DATA", "ontab selected");
			pager.setCurrentItem(tab.getPosition());
			if (selectedImagePath != null) {

				ImageView imageMap = (ImageView) findViewById(R.id.imageMapVizualizedata);
				imageMap.setImageURI(null);
				imageMap.setImageURI(selectedImageUri);
			}

			// getData();

		}

		@Override
		public void onTabUnselected(Tab arg0, FragmentTransaction arg1) {
			Log.w("tablistener DATA", "ontab unselected");

		}

		public void getData() {

			final CatchDataBaseHandler db = new CatchDataBaseHandler(
					getApplicationContext());

			List<Catch> catchs = db.getAllCatchs();

			for (final Catch ct : catchs) {

				ImageButton CatchButtonData = new ImageButton(
						getApplicationContext());

				RelativeLayout r2 = (RelativeLayout) findViewById(R.id.relativeLayoutVisualizeData);
				RelativeLayout.LayoutParams paramsdata = new RelativeLayout.LayoutParams(
						30, 30);

				final int coordX = (int) ct.getX();
				final int coordY = (int) ct.getY();

				CatchButtonData.setImageResource(R.drawable.rose212);
				CatchButtonData.setOnClickListener(new OnClickListener() {

					@Override
					public void onClick(View v) {

						List<Wifi> OnePositionWifisList = db
								.getAllWifisByCatch(ct.getId_catch());

						Spanned formattedText;

						CharSequence sequenceMsg;

						String messageToDisplay = "WIFI informations \n";

						formattedText = Html
								.fromHtml("<font color='#7FC6BC'><b>"
										+ messageToDisplay + ": </b></font>");
						sequenceMsg = formattedText;

						for (Wifi wi : OnePositionWifisList) {
							int r = db.getWifiByCatch(ct.getId_catch(),
									wi.getBSSID());

							messageToDisplay = messageToDisplay + wi.getSSID()
									+ "   :   " + r + "\n";

							formattedText = Html
									.fromHtml(" <br/> <font color='#046380'><b> "
											+ wi.getSSID()
											+ ": </b></font>"
											+ r + "\n . ");
							sequenceMsg = TextUtils.concat(sequenceMsg,
									formattedText);
						}

						messageToDisplay = "CELLTOWERS Informations \n";
						formattedText = Html
								.fromHtml("<font color='#7FC6BC'><b>"
										+ messageToDisplay + ": </b></font>");
						sequenceMsg = TextUtils.concat(sequenceMsg,
								formattedText);

						List<GsmCell> OnePositionCellList = db
								.getAllGsmCellsByCatch(ct.getId_catch());

						for (GsmCell gsm : OnePositionCellList) {
							int r = db.getCellStrengthByCatch(ct.getId_catch(),
									gsm.getCid());
							messageToDisplay = messageToDisplay + gsm.getCid()
									+ " :  " + r + "\n";

							formattedText = Html
									.fromHtml(" <br/> <font color='#046380'><b> Cell Id: "
											+ gsm.getCid()
											+ ": </b></font>"
											+ r + " \n");
							sequenceMsg = TextUtils.concat(sequenceMsg,
									formattedText);

						}

						AlertDialog.Builder alertDialog = new AlertDialog.Builder(
								MainActivity.this);

						alertDialog.setTitle(Html
								.fromHtml("<font color='#7FC6BC'><b>Data : </b></font>"));
						alertDialog.setNeutralButton("OK", null);

						alertDialog.setMessage(sequenceMsg);
						alertDialog.show();
					}
				});

				ImageView map = (ImageView) findViewById(R.id.imageMapVizualizedata);

				float[] f = new float[9];
				map.getImageMatrix().getValues(f);
				final float scaleX = f[Matrix.MSCALE_X];
				final float scaleY = f[Matrix.MSCALE_Y];
				final Drawable d = map.getDrawable();
				final int originalW = originalWImage;
				final int originalH = originaHImage;
				final int actualW = Math.round(originalW * scaleX);
				final int actualH = Math.round(originalH * scaleY);
				double imageViewRatio = (double) widthImage
						/ (double) heightImage;
				Log.w("widhimage static", widthImage + "");
				Log.w("heightimage static", heightImage + "");

				double imgRatio = (double) ((actualW * scaleX) / (actualH * scaleY));

				double h = 0, w = 0;
				double x = 0, y = 0;

				if (imgRatio > imageViewRatio) {
					h = (imageViewRatio / imgRatio) * heightImage;
					y = (heightImage - h) / 2;
				} else {
					w = (imgRatio / imageViewRatio) * widthImage;
					x = (widthImage - w) / 2;
				}

				int posX = (int) (x + coordX);
				int posY = (int) (y + coordY);

				CatchButtonData.setLayoutParams(paramsdata);
				paramsdata.leftMargin = (posX - 15);
				paramsdata.topMargin = (posY - 15);
				r2.addView(CatchButtonData, paramsdata);
				CatchButtonData.bringToFront();
			}

		}

	};

	ActionBar.TabListener collectListener = new ActionBar.TabListener() {

		@Override
		public void onTabReselected(Tab arg0, FragmentTransaction arg1) {

			Log.w("tablistener COLLECT", "ontab reselected");

			placeAllPins();
		}

		@Override
		public void onTabSelected(Tab tab, FragmentTransaction arg1) {

			Log.w("tablistener COLLECT", "ontab selected");

			pager.setCurrentItem(tab.getPosition());

			if (selectedImagePath != null) {
				ImageView imageMap = (ImageView) findViewById(R.id.imageMap);
				imageMap.setImageURI(null);
				imageMap.setImageURI(selectedImageUri);
			}

			// placeAllPins();

		}

		@Override
		public void onTabUnselected(Tab arg0, FragmentTransaction arg1) {
			Log.w("tablistener COLLECT", "ontab unselected");

			if (selectedImagePath != null) {
				ImageView imageMap = (ImageView) findViewById(R.id.imageMap);
				imageMap.setImageURI(null);
				imageMap.setImageURI(selectedImageUri);
			} else {
				ImageView Map = (ImageView) findViewById(R.id.imageMap);
				Map.setImageResource(R.drawable.thinktankmap);
			}
		}

		public void placeAllPins() {

			Log.w("place all pins", "place all pins");

			final CatchDataBaseHandler db = new CatchDataBaseHandler(
					getApplicationContext());

			List<Catch> catchs = db.getAllCatchs();

			for (final Catch ct : catchs) {

				RelativeLayout rl = (RelativeLayout) findViewById(R.id.relativeLayoutMap);
				if (rl == null) {
					Log.w("relativeLayout", "null");
				}
				ImageView PinImgViewConstant = new ImageView(MainActivity.this);
				PinImgViewConstant.setImageResource(R.drawable.mapconstantpin);
				RelativeLayout.LayoutParams params = new RelativeLayout.LayoutParams(
						30, 30);

				final int coordX = (int) ct.getX();
				final int coordY = (int) ct.getY();

				ImageView map = (ImageView) findViewById(R.id.imageMap);
				float[] f = new float[9];
				map.getImageMatrix().getValues(f);
				final float scaleX = f[Matrix.MSCALE_X];
				final float scaleY = f[Matrix.MSCALE_Y];
				final Drawable d = map.getDrawable();
				final int originalW = originalWImage;
				final int originalH = originaHImage;
				final int actualW = Math.round(originalW * scaleX);
				final int actualH = Math.round(originalH * scaleY);
				double imageViewRatio = (double) widthImage
						/ (double) heightImage;
				Log.w("widhimage static", widthImage + "");
				Log.w("heightimage static", heightImage + "");

				double imgRatio = (double) ((actualW * scaleX) / (actualH * scaleY));

				double h = 0, w = 0;
				double x = 0, y = 0;

				if (imgRatio > imageViewRatio) {
					h = (imageViewRatio / imgRatio) * heightImage;
					y = (heightImage - h) / 2;
				} else {
					w = (imgRatio / imageViewRatio) * widthImage;
					x = (widthImage - w) / 2;
				}

				int posX = (int) (x + coordX);
				int posY = (int) (y + coordY);

				Log.e("x,y", x + "**" + y + "");
				Log.e("cordoonnées x y", coordX + "**" + coordY + "");
				Log.e("positionsx y", posX + "''" + posY);

				PinImgViewConstant.setLayoutParams(params);
				params.leftMargin = (int) (posX - 20);
				params.topMargin = (int) (posY - 20);
				rl.addView(PinImgViewConstant, params);
				PinImgViewConstant.bringToFront();
			}
		}

	};

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {

		getMenuInflater().inflate(R.menu.main, menu);
		return true;
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item) {

		int id = item.getItemId();
		if (id == R.id.action_settings) {
			return true;
		}
		return super.onOptionsItemSelected(item);
	}

	public void chooseMap(View view) {

		CatchDataBaseHandler db = new CatchDataBaseHandler(
				getApplicationContext());
		db.deleteAllCatchs();
		db.deleteAllWifis();
		db.deleteAllWifis_catch();
		db.deleteAllGsmCells();
		db.deleteAllGsmCells_catch();

		Intent intent = new Intent();
		intent.setType("image/*");
		intent.setAction(Intent.ACTION_GET_CONTENT);
		startActivityForResult(
				Intent.createChooser(intent, "Select Picture please!"),
				PICK_IMAGE);

	}

	public void onActivityResult(int requestCode, int resultCode, Intent data) {

		if (requestCode == PICK_IMAGE) {
			selectedImageUri = data.getData();
			selectedImagePath = getPath(selectedImageUri);
			System.out.println("Image Path : " + selectedImagePath);
			System.out.println("Image uri : " + selectedImageUri.toString());

			if (selectedImagePath != null) {
				ImageView imageMap = (ImageView) findViewById(R.id.imageMap);
				imageMap.setImageURI(null);
				imageMap.setImageURI(selectedImageUri);
				imageMap.bringToFront();
				pager.setCurrentItem(1);
				ImageView imageMapData = (ImageView) findViewById(R.id.imageMapVizualizedata);
				if (imageMapData == null) {
					Log.w("imagemapadata", imageMapData + "");
				}
				imageMapData.setImageURI(null);
				imageMapData.setImageURI(selectedImageUri);
			}
		}
	}

	public void visualizeData(View view) {

		pager.setCurrentItem(2);
	}

	public void analysis(View view) {

		pager.setCurrentItem(3);
	}

	public String getPath(Uri uri) {
		String[] projection = { MediaStore.Images.Media.DATA };
		Cursor cursor = this.getContentResolver().query(uri, projection, null,
				null, null);
		int column_index = cursor
				.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);
		cursor.moveToFirst();
		return cursor.getString(column_index);
	}

	ActionBar.TabListener tabListenerAnalysis = new ActionBar.TabListener() {

		@Override
		public void onTabReselected(Tab arg0, FragmentTransaction arg1) {
			Log.w("tablistener analyse", "ontab reselected");
		}

		@Override
		public void onTabSelected(Tab tab, FragmentTransaction arg1) {

			Log.w("tablistener analyse", "ontab selected");
			pager.setCurrentItem(tab.getPosition());
			if (selectedImagePath != null) {
				ImageView imageMap = (ImageView) findViewById(R.id.imageMapAnalysis);
				imageMap.setImageURI(null);
				imageMap.setImageURI(selectedImageUri);
			}
		}

		@Override
		public void onTabUnselected(Tab arg0, FragmentTransaction arg1) {
			Log.w("tablistener analyse", "ontab unselected");
		}
	};

	public static class PlaceholderFragment extends Fragment {

		public PlaceholderFragment() {
		}

		@Override
		public View onCreateView(LayoutInflater inflater, ViewGroup container,
				Bundle savedInstanceState) {
			View rootView = inflater.inflate(R.layout.fragment_main, container,
					false);
			return rootView;
		}
	}

};